<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Gest√£o de Usu√°rios ‚Äî Fazzo PDV</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: #f1f5f9;
    min-height: 100vh;
    color: #1e293b;
  }

  /* HEADER */
  .header {
    background: linear-gradient(135deg, #4f7cff, #7c3aed);
    padding: 16px 24px;
    display: flex;
    align-items: center;
    gap: 12px;
    box-shadow: 0 2px 12px rgba(0,0,0,.15);
  }

  .header a {
    color: rgba(255,255,255,.7);
    text-decoration: none;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .header a:hover { color: #fff; }

  .header h1 {
    color: #fff;
    font-size: 18px;
    font-weight: 700;
    margin-left: 4px;
  }

  /* CONTENT */
  .content {
    max-width: 860px;
    margin: 28px auto;
    padding: 0 16px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  /* INVITE CARD */
  .card {
    background: #fff;
    border-radius: 14px;
    box-shadow: 0 2px 12px rgba(0,0,0,.06);
    overflow: hidden;
  }

  .card-header {
    padding: 18px 24px;
    border-bottom: 1px solid #f1f5f9;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
  }

  .card-header h2 {
    font-size: 15px;
    font-weight: 700;
    color: #1e293b;
  }

  /* INVITE FORM */
  .invite-form {
    padding: 20px 24px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .invite-form input[type="email"] {
    flex: 1;
    min-width: 200px;
    padding: 10px 14px;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    font-size: 14px;
    color: #1e293b;
    transition: border-color .2s;
  }
  .invite-form input[type="email"]:focus {
    outline: none;
    border-color: #4f7cff;
  }

  .invite-form select {
    padding: 10px 14px;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    font-size: 14px;
    color: #1e293b;
    background: #fff;
    cursor: pointer;
    transition: border-color .2s;
  }
  .invite-form select:focus {
    outline: none;
    border-color: #4f7cff;
  }

  .btn {
    padding: 10px 20px;
    border: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    transition: opacity .15s, transform .1s;
    white-space: nowrap;
  }
  .btn:hover { opacity: .88; }
  .btn:active { transform: scale(.97); }
  .btn-primary { background: #4f7cff; color: #fff; }
  .btn-danger  { background: #ef4444; color: #fff; padding: 6px 12px; font-size: 12px; }
  .btn-ghost   { background: #f1f5f9; color: #64748b; }

  /* FILTER BAR */
  .filter-bar {
    padding: 12px 24px;
    border-bottom: 1px solid #f1f5f9;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    align-items: center;
  }

  .filter-bar input {
    flex: 1;
    min-width: 180px;
    padding: 8px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    font-size: 13px;
  }
  .filter-bar input:focus { outline: none; border-color: #4f7cff; }

  .filter-pill {
    padding: 6px 14px;
    border-radius: 20px;
    border: 1.5px solid #e2e8f0;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    background: #fff;
    color: #64748b;
    transition: all .15s;
  }
  .filter-pill.active { background: #4f7cff; color: #fff; border-color: #4f7cff; }

  /* USER TABLE */
  .user-table {
    width: 100%;
    border-collapse: collapse;
  }

  .user-table th {
    padding: 10px 16px;
    text-align: left;
    font-size: 11px;
    font-weight: 700;
    color: #94a3b8;
    text-transform: uppercase;
    letter-spacing: .5px;
    background: #f8fafc;
    border-bottom: 1px solid #f1f5f9;
  }

  .user-table td {
    padding: 14px 16px;
    border-bottom: 1px solid #f8fafc;
    vertical-align: middle;
  }

  .user-table tr:last-child td { border-bottom: none; }
  .user-table tr:hover td { background: #fafbff; }

  .user-info {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .user-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
    background: #e2e8f0;
  }

  .user-avatar-placeholder {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, #4f7cff, #7c3aed);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 700;
    color: #fff;
    flex-shrink: 0;
  }

  .user-name { font-weight: 600; font-size: 14px; color: #1e293b; }
  .user-email { font-size: 12px; color: #94a3b8; }

  /* ROLE BADGE */
  .role-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .4px;
  }
  .role-badge.admin          { background: #fef3c7; color: #92400e; }
  .role-badge.estabelecimento { background: #dbeafe; color: #1e40af; }
  .role-badge.funcionario    { background: #f1f5f9; color: #64748b; }

  /* ROLE SELECT inline */
  .role-select {
    padding: 6px 10px;
    border: 1.5px solid #e2e8f0;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    background: #fff;
    cursor: pointer;
    transition: border-color .2s;
  }
  .role-select:focus { outline: none; border-color: #4f7cff; }
  .role-select.saving { opacity: .5; pointer-events: none; }

  /* STATUS */
  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 5px;
  }
  .status-dot.ativo   { background: #10b981; }
  .status-dot.inativo { background: #e2e8f0; }

  /* TOGGLE ativo */
  .toggle {
    position: relative;
    width: 38px;
    height: 22px;
    cursor: pointer;
  }
  .toggle input { opacity: 0; width: 0; height: 0; }
  .toggle-slider {
    position: absolute;
    inset: 0;
    background: #e2e8f0;
    border-radius: 22px;
    transition: .2s;
  }
  .toggle-slider::before {
    content: "";
    position: absolute;
    width: 16px; height: 16px;
    left: 3px; bottom: 3px;
    background: #fff;
    border-radius: 50%;
    transition: .2s;
    box-shadow: 0 1px 3px rgba(0,0,0,.2);
  }
  .toggle input:checked + .toggle-slider { background: #10b981; }
  .toggle input:checked + .toggle-slider::before { transform: translateX(16px); }

  /* LOADING / EMPTY */
  .state-row td {
    text-align: center;
    padding: 40px;
    color: #94a3b8;
    font-size: 14px;
  }

  .spinner {
    display: inline-block;
    width: 24px; height: 24px;
    border: 3px solid #e2e8f0;
    border-top-color: #4f7cff;
    border-radius: 50%;
    animation: spin .7s linear infinite;
    margin-bottom: 8px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* TOAST */
  .toast {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: #1e293b;
    color: #fff;
    padding: 12px 24px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    transition: transform .3s;
    z-index: 999;
    white-space: nowrap;
    pointer-events: none;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }
  .toast.green { background: #10b981; }
  .toast.red   { background: #ef4444; }

  /* CONTAGEM */
  .count-badge {
    background: #f1f5f9;
    color: #64748b;
    border-radius: 20px;
    padding: 2px 10px;
    font-size: 12px;
    font-weight: 700;
  }

  @media (max-width: 600px) {
    .user-table th:nth-child(4),
    .user-table td:nth-child(4) { display: none; }
    .invite-form { flex-direction: column; }
    .invite-form input, .invite-form select, .invite-form .btn { width: 100%; }
  }

  /* PENDING APPROVALS */
  .pending-card {
    background: #fff; border-radius: 14px;
    box-shadow: 0 2px 12px rgba(0,0,0,.06);
    overflow: hidden; border: 2px solid #fef3c7;
  }
  .pending-card .card-header { background: #fffbeb; border-bottom: 1px solid #fde68a; }
  .pending-card .card-header h2 { color: #92400e; }
  .pending-list { display: flex; flex-direction: column; gap: 0; }
  .pending-item {
    display: flex; align-items: center; gap: 14px;
    padding: 16px 24px; border-bottom: 1px solid #f1f5f9; transition: background .15s;
  }
  .pending-item:last-child { border-bottom: none; }
  .pending-item:hover { background: #fffbeb; }
  .pending-avatar {
    width: 40px; height: 40px; border-radius: 50%;
    object-fit: cover; flex-shrink: 0;
  }
  .pending-avatar-placeholder {
    width: 40px; height: 40px; border-radius: 50%;
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: #fff; display: flex; align-items: center; justify-content: center;
    font-weight: 700; font-size: 16px; flex-shrink: 0;
  }
  .pending-info { flex: 1; min-width: 0; }
  .pending-name  { font-size: 14px; font-weight: 700; color: #1e293b; }
  .pending-email { font-size: 12px; color: #64748b; margin-top: 2px; }
  .pending-date  { font-size: 11px; color: #94a3b8; margin-top: 2px; }
  .pending-actions { display: flex; gap: 8px; flex-shrink: 0; }
  .btn-aprovar {
    padding: 7px 16px; background: #dcfce7; border: 1px solid #86efac;
    border-radius: 8px; color: #166534; font-size: 13px; font-weight: 700;
    cursor: pointer; transition: all .15s; font-family: inherit;
  }
  .btn-aprovar:hover { background: #bbf7d0; }
  .btn-rejeitar {
    padding: 7px 12px; background: #fef2f2; border: 1px solid #fca5a5;
    border-radius: 8px; color: #991b1b; font-size: 13px; font-weight: 700;
    cursor: pointer; transition: all .15s; font-family: inherit;
  }
  .btn-rejeitar:hover { background: #fee2e2; }
  .role-select-pending {
    padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 8px;
    font-size: 13px; color: #1e293b; background: #fff; font-family: inherit;
  }
  .empty-pending {
    padding: 32px; text-align: center; color: #94a3b8; font-size: 14px;
  }
</style>
</head>
<body>

<div class="header">
  <a href="gestao.html">‚Üê Gest√£o</a>
  <h1>üë• Gest√£o de Usu√°rios</h1>
</div>

<div class="content">

  <!-- CARD: PR√â-AUTORIZAR E-MAIL -->
  <div class="card">
    <div class="card-header">
      <h2>‚ûï Pr√©-autorizar e-mail</h2>
      <span style="font-size:12px;color:#94a3b8">O papel ser√° aplicado quando o usu√°rio fizer login</span>
    </div>
    <div class="invite-form">
      <input type="email" id="emailInput" placeholder="email@exemplo.com">
      <select id="papelInput">
        <option value="funcionario">Funcion√°rio</option>
        <option value="estabelecimento">Estabelecimento</option>
        <option value="admin">Admin</option>
      </select>
      <button class="btn btn-primary" onclick="preAutorizar()">Salvar</button>
    </div>
  </div>

  <!-- CARD: APROVA√á√ïES PENDENTES -->
  <div class="pending-card" id="pendingCard" style="display:none">
    <div class="card-header">
      <h2>‚è≥ Aguardando aprova√ß√£o <span class="count-badge" id="pendingCount" style="background:#f59e0b">0</span></h2>
      <span style="font-size:12px;color:#92400e">Usu√°rios que fizeram login mas aguardam libera√ß√£o</span>
    </div>
    <div class="pending-list" id="pendingList">
      <div class="empty-pending">Nenhum pendente</div>
    </div>
  </div>

  <!-- CARD: LISTA DE USU√ÅRIOS -->
  <div class="card">
    <div class="card-header">
      <h2>Usu√°rios cadastrados <span class="count-badge" id="contagem">0</span></h2>
    </div>

    <div class="filter-bar">
      <input type="text" id="filtroTexto" placeholder="üîç Buscar por nome ou e-mail..." oninput="filtrar()">
      <button class="filter-pill active" onclick="setFiltro('todos', this)">Todos</button>
      <button class="filter-pill" onclick="setFiltro('admin', this)">Admin</button>
      <button class="filter-pill" onclick="setFiltro('estabelecimento', this)">Estabelecimento</button>
      <button class="filter-pill" onclick="setFiltro('funcionario', this)">Funcion√°rio</button>
    </div>

    <table class="user-table">
      <thead>
        <tr>
          <th>Usu√°rio</th>
          <th>Papel</th>
          <th>Status</th>
          <th>√öltimo acesso</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="tbodyUsuarios">
        <tr class="state-row">
          <td colspan="5"><div class="spinner"></div><br>Carregando...</td>
        </tr>
      </tbody>
    </table>
  </div>

</div>

<div class="toast" id="toast"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="config.js"></script>
<script>
  if (!firebase.apps.length) firebase.initializeApp(APP_CONFIG.firebase);
  const db = firebase.firestore();

  let todosUsuarios = [];
  let filtroAtivo = "todos";

  // ===== AUTH GUARD =====
  firebase.auth().onAuthStateChanged(async user => {
    if (!user) { window.location.href = "login.html"; return; }

    // Verifica se √© admin
    const doc = await db.collection("usuarios").doc(user.uid).get();
    const papel = doc.exists ? doc.data().papel : null;
    if (papel !== "admin") {
      alert("Acesso restrito a administradores.");
      window.location.href = "pdv.html";
      return;
    }

    carregarUsuarios();
  });

  // ===== CARREGAR USU√ÅRIOS =====
  function carregarUsuarios() {
    db.collection("usuarios").orderBy("criadoEm", "desc")
      .onSnapshot(snap => {
        todosUsuarios = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        filtrar();
      }, err => {
        console.error(err);
        document.getElementById("tbodyUsuarios").innerHTML =
          `<tr class="state-row"><td colspan="5">‚ùå Erro ao carregar usu√°rios.</td></tr>`;
      });
  }

  // ===== FILTRAR =====
  function setFiltro(papel, btn) {
    filtroAtivo = papel;
    document.querySelectorAll(".filter-pill").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    filtrar();
  }

  function filtrar() {
    const texto = document.getElementById("filtroTexto").value.toLowerCase();
    let lista = todosUsuarios;

    if (filtroAtivo !== "todos") {
      lista = lista.filter(u => u.papel === filtroAtivo);
    }

    if (texto) {
      lista = lista.filter(u =>
        (u.nome || "").toLowerCase().includes(texto) ||
        (u.email || "").toLowerCase().includes(texto)
      );
    }

    const ativos = lista.filter(u => u.status !== "pendente" || u.pendente);
    document.getElementById("contagem").textContent = ativos.length;
    renderPendentes(todosUsuarios);
    renderTabela(ativos);
  }

  // ===== RENDER TABELA =====
  function renderTabela(lista) {
    const tbody = document.getElementById("tbodyUsuarios");

    if (lista.length === 0) {
      tbody.innerHTML = `<tr class="state-row"><td colspan="5">Nenhum usu√°rio encontrado.</td></tr>`;
      return;
    }

    tbody.innerHTML = lista.map(u => {
      const iniciais = (u.nome || u.email || "?").charAt(0).toUpperCase();
      const avatar = u.foto
        ? `<img src="${u.foto}" class="user-avatar" onerror="this.style.display='none'">`
        : `<div class="user-avatar-placeholder">${iniciais}</div>`;

      const ultimoAcesso = u.ultimoAcesso
        ? new Date(u.ultimoAcesso).toLocaleDateString("pt-BR", { day:"2-digit", month:"2-digit", year:"2-digit", hour:"2-digit", minute:"2-digit" })
        : "‚Äî";

      const ativo = u.ativo !== false;

      return `
        <tr>
          <td>
            <div class="user-info">
              ${avatar}
              <div>
                <div class="user-name">${u.nome || "Sem nome"}</div>
                <div class="user-email">${u.email || "‚Äî"}</div>
              </div>
            </div>
          </td>
          <td>
            <select class="role-select" onchange="alterarPapel('${u.id}', this)">
              <option value="funcionario"   ${u.papel === "funcionario"   ? "selected" : ""}>üë§ Funcion√°rio</option>
              <option value="estabelecimento" ${u.papel === "estabelecimento" ? "selected" : ""}>üè™ Estabelecimento</option>
              <option value="admin"          ${u.papel === "admin"          ? "selected" : ""}>‚≠ê Admin</option>
            </select>
          </td>
          <td>
            <label class="toggle" title="${ativo ? "Ativo" : "Inativo"}">
              <input type="checkbox" ${ativo ? "checked" : ""} onchange="toggleAtivo('${u.id}', this.checked)">
              <span class="toggle-slider"></span>
            </label>
          </td>
          <td style="font-size:12px;color:#94a3b8">${ultimoAcesso}</td>
          <td>
            <button class="btn btn-danger" onclick="confirmarRemover('${u.id}', '${(u.nome || u.email || "").replace(/'/g, "\\'")}')">
              üóëÔ∏è
            </button>
          </td>
        </tr>`;
    }).join("");
  }

  // ===== ALTERAR PAPEL =====
  async function alterarPapel(uid, selectEl) {
    const novoPapel = selectEl.value;
    selectEl.classList.add("saving");
    try {
      await db.collection("usuarios").doc(uid).update({
        papel: novoPapel,
        dataAtualizacao: new Date().toISOString()
      });
      toast(`‚úÖ Papel atualizado: ${novoPapel}`, "green");
    } catch (e) {
      console.error(e);
      toast("‚ùå Erro ao atualizar papel", "red");
    } finally {
      selectEl.classList.remove("saving");
    }
  }

  // ===== TOGGLE ATIVO =====
  async function toggleAtivo(uid, ativo) {
    try {
      await db.collection("usuarios").doc(uid).update({
        ativo,
        dataAtualizacao: new Date().toISOString()
      });
      toast(ativo ? "‚úÖ Usu√°rio ativado" : "‚õî Usu√°rio desativado");
    } catch (e) {
      console.error(e);
      toast("‚ùå Erro ao atualizar status", "red");
    }
  }

  // ===== REMOVER =====
  function confirmarRemover(uid, nome) {
    if (!confirm(`Remover "${nome}" do sistema?\nEle precisar√° de nova autoriza√ß√£o para acessar.`)) return;
    db.collection("usuarios").doc(uid).delete()
      .then(() => toast("üóëÔ∏è Usu√°rio removido"))
      .catch(() => toast("‚ùå Erro ao remover", "red"));
  }

  // ===== PR√â-AUTORIZAR E-MAIL =====
  async function preAutorizar() {
    const email = document.getElementById("emailInput").value.trim().toLowerCase();
    const papel = document.getElementById("papelInput").value;

    if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      toast("‚ùå E-mail inv√°lido", "red"); return;
    }

    // Verificar se j√° existe
    const snap = await db.collection("usuarios").where("email", "==", email).get();
    if (!snap.empty) {
      // Usu√°rio j√° existe: s√≥ atualiza o papel
      await snap.docs[0].ref.update({ papel, dataAtualizacao: new Date().toISOString() });
      toast(`‚úÖ Papel de ${email} atualizado para ${papel}`, "green");
    } else {
      // Cria registro pendente (sem uid ainda)
      await db.collection("usuarios").add({
        uid:          null,
        nome:         "",
        email,
        foto:         "",
        papel,
        ativo:        true,
        pendente:     true,
        criadoEm:     new Date().toISOString(),
        ultimoAcesso: null
      });
      toast(`‚úÖ ${email} pr√©-autorizado como ${papel}`, "green");
    }

    document.getElementById("emailInput").value = "";
  }

  // ===== TOAST =====
  function toast(msg, tipo = "") {
    const el = document.getElementById("toast");
    el.textContent = msg;
    el.className = "toast " + tipo;
    el.classList.add("show");
    setTimeout(() => el.classList.remove("show"), 2800);
  }

  // ===== PENDENTES =====
  function renderPendentes(lista) {
    const pendentes = lista.filter(u => u.status === "pendente" && !u.pendente);
    const card = document.getElementById("pendingCard");
    const el   = document.getElementById("pendingList");
    document.getElementById("pendingCount").textContent = pendentes.length;

    if (!pendentes.length) {
      card.style.display = "none";
      return;
    }
    card.style.display = "";

    el.innerHTML = pendentes.map(u => {
      const ini = (u.nome || u.email || "?").charAt(0).toUpperCase();
      const av  = u.foto
        ? `<img src="${u.foto}" class="pending-avatar" onerror="this.outerHTML='<div class=\'pending-avatar-placeholder\'>${ini}</div>'">`
        : `<div class="pending-avatar-placeholder">${ini}</div>`;
      const dt  = u.criadoEm ? new Date(u.criadoEm).toLocaleDateString("pt-BR") : "‚Äî";
      return `
        <div class="pending-item" id="pi-${u.id}">
          ${av}
          <div class="pending-info">
            <div class="pending-name">${u.nome || "(sem nome)"}</div>
            <div class="pending-email">${u.email}</div>
            <div class="pending-date">Solicitado em: ${dt}</div>
          </div>
          <div class="pending-actions">
            <select class="role-select-pending" id="role-${u.id}">
              <option value="funcionario">Funcion√°rio</option>
              <option value="estabelecimento">Estabelecimento</option>
              <option value="admin">Admin</option>
            </select>
            <button class="btn-aprovar" onclick="aprovar('${u.id}')">‚úÖ Aprovar</button>
            <button class="btn-rejeitar" onclick="rejeitar('${u.id}', '${(u.nome||u.email||'').replace(/'/g,"\'")}')">‚úï Recusar</button>
          </div>
        </div>`;
    }).join("");
  }

  async function aprovar(uid) {
    const papel = document.getElementById("role-" + uid)?.value || "funcionario";
    await db.collection("usuarios").doc(uid).update({
      status: "aprovado", papel, aprovadoEm: new Date().toISOString()
    });
    showToast("‚úÖ Usu√°rio aprovado como " + papel + "!");
  }

  async function rejeitar(uid, nome) {
    if (!confirm(`Recusar acesso de "${nome}"?\nO usu√°rio ser√° removido do sistema.`)) return;
    await db.collection("usuarios").doc(uid).delete();
    showToast("‚ùå Acesso recusado.");
  }
</script>
</body>
</html>